name: churn - imbalanced - dataset

on: [push]

permissions:
  contents: write
  pull-requests: write

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install CML utility
        uses: iterative/setup-cml@v2

      - name: Install dependencies (Python, DVC, CML)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install "dvc[gdrive]==3.63.0"
          # pip install cml # si pas dans requirements.txt

      - name: Configure DVC remote for Google Drive (OAuth)
        run: |
          # Le remote existe dÃ©jÃ  dans .dvc/config (committÃ© dans Git)
          # On vÃ©rifie juste qu'il est bien lÃ 
          dvc remote list
          
          # CrÃ©er le fichier de credentials OAuth Ã  partir des secrets GitHub
          cat > .dvc/gdrive-creds.json <<EOF
          {
            "client_id": "${{ secrets.GDRIVE_CLIENT_ID }}",
            "client_secret": "${{ secrets.GDRIVE_CLIENT_SECRET }}",
            "refresh_token": "${{ secrets.GDRIVE_REFRESH_TOKEN }}",
            "token_uri": "https://oauth2.googleapis.com/token"
          }
          EOF
          
          # Configurer DVC pour utiliser ce fichier (config locale uniquement)
          dvc remote modify --local new_gdrive gdrive_user_credentials_file .dvc/gdrive-creds.json
          dvc remote modify --local new_gdrive gdrive_client_id "${{ secrets.GDRIVE_CLIENT_ID }}"
          dvc remote modify --local new_gdrive gdrive_client_secret "${{ secrets.GDRIVE_CLIENT_SECRET }}"
          
          # Diagnostic
          echo "=== DVC Remote Configuration ==="
          dvc remote list
          echo "=== DVC Local Config ==="
          dvc config --local --list

      - name: Pull data & models from DVC remote (Drive)
        run: |
          echo "Pulling data and models from Google Drive..."
          dvc pull -v

      - name: Train / Evaluate model(s)
        run: |
          echo "Training model..."
          python src/script.py
          # VÃ©rifier que les fichiers ont Ã©tÃ© gÃ©nÃ©rÃ©s
          ls -la metrics.txt conf_matrix.png

      - name: Track new artifacts with DVC
        run: |
          echo "Adding changes to DVC..."
          dvc add data/
          dvc add models/
          
          # Configurer Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Committer les fichiers .dvc mis Ã  jour
          git add data.dvc models.dvc metrics.txt conf_matrix.png .gitignore
          git diff --staged --quiet || git commit -m "Update DVC artifacts [skip ci]"

      - name: Push data & models to DVC remote (Drive)
        run: |
          echo "Pushing artifacts to Google Drive..."
          dvc push -v

      - name: Push changes to GitHub
        run: |
          git push origin main

      - name: Generate and publish CML report
        if: always()
        run: |
          echo "## ðŸ“Š Training Metrics" > report.md
          echo "" >> report.md
          
          if [ -f metrics.txt ]; then
            echo "\`\`\`" >> report.md
            cat metrics.txt >> report.md
            echo "\`\`\`" >> report.md
          else
            echo "âŒ metrics.txt not found" >> report.md
          fi
          
          echo "" >> report.md
          echo "## ðŸŽ¯ Confusion Matrix" >> report.md
          echo "" >> report.md
          
          if [ -f conf_matrix.png ]; then
            cml publish conf_matrix.png --md >> report.md
          else
            echo "âŒ conf_matrix.png not found" >> report.md
          fi
          
          # Publier le rapport
          cml comment create report.md